/* by a-sansara - v 0.8 - https://github.com/pluie-org/bt */var $l=function(){var a=localStorage;return{clear:function(){return a.clear()},get:function(n){return a.getItem(n)},rem:function(n){return a.removeItem(n)},set:function(n,i){return a.setItem(n,i)}}}(),$j=function(){var a=JSON;return{str:function(n){return a.stringify(n)},obj:function(s){return a.parse(s)}}}(),$bt={VERSION:.8,UID:null,HASH:null,TRACE:!0&&!$.isNone(console),setConstant:function(n,i){if(!i){if(null==this.UID)throw Error('UID is not define, you need to define $bt.UID or provide the "name" parameter');return null==this.HASH&&(this.HASH=this._getHash(this.UID)),this.HASH+"."+n}return _getHash(i)+"."+n},vars:[],callbacks:[],zomblist:[],zkillonload:!0,zombTimeout:250,init:function(n,i){if(!i&&$.isFunc(n)||0==arguments.length){if(null==this.UID)throw Error('UID is not define, you need to define $bt.UID or provide the "uid" parameter');arguments.length>0&&(i=n),n=this.UID}this._initConstant(n),this._init(i)},log:function(n){this.TRACE&&console.log(n)},send:function(n){n.uid=this.id+Math.random(),n.from=this.id,$.isNone(n.to)&&(n.to="*"),n=$j.str(n),$bt.log("sending cmd : "+this.LS_CMD+" : "+n),$l.set(this.LS_CMD,n),$l.rem(this.LS_CMD)},append:function(n,i,o,r,b){this._dom(this.CMD_APPEND,o,n,i,r,b)},prepend:function(n,i,o,r,b){this._dom(this.CMD_PREPEND,o,n,i,r,b)},html:function(n,i,o,r,b){this._dom(this.CMD_HTML,o,n,i,r,b)},sync:function(n,i,o,r){var b=$.isNone(i)||null==i?document:parent.frames[i].document;this._dom(this.CMD_HTML,i,n,$(n,b).html(),o,r)},reload:function(n,i){$bt.send({name:$bt.CMD_RELOAD,url:n,to:i?i:"*"})},setCallback:function(n,i){$.isNone($bt.callbacks[n])?$bt.callbacks[n]=i:console.log("BT ERROR : callback name already exist")},zombkill:function(n,i){var o=(new Date).getTime();$bt.zomblist[""+o]=[],$bt.list.forEach(function(n){n!=$bt.id&&($bt.zomblist[""+o]["ping"+n]="")}),$bt.send({name:$bt.CMD_ZOMBKILL,askid:o,to:"*"});var r=setTimeout(function(){$bt._refresh();for(var i in $bt.zomblist[""+o])if("pong"!=$bt.zomblist[""+o][i]){var b=$bt.list.indexOf(parseInt(i.substring(4)));b>-1&&$bt.list.splice(b,1)}$l.set($bt.LS_TABS,$j.str($bt.list)),$bt._broadcast(),$bt.log($bt.list),clearTimeout(r),$.isFunc(n)&&n()},i?i:$bt.zombTimeout)},varset:function(n,i,o,r){try{var b=$j.str(i);$bt.vars[n]=i,$bt.send({name:$bt.CMD_VAR_SET,varName:n,data:b,callback:o,to:r?r:"*"})}catch(l){console.log(l)}},varsync:function(n,i,o){$bt.send({name:$bt.CMD_VAR_SYNC,varName:n,data:"",callback:i,to:o})},attr:function(n,i,o,r,b){var l=o?window.parent.frames[o].document:document;$.isStr(i)&&(i=[i]);var c=[];i.forEach(function(i){c.push("disabled"!=i?$(n,l).attr(i):$(n,l).first().disabled)}),$bt.send({name:$bt.CMD_ATTR_SYNC,attr:i,selector:n,data:c,context:o,callback:r,to:b?b:"*"})},_dontkill:function(n,i){$bt.send({name:$bt.CMD_DONTKILL,askid:n,to:i})},_refresh:function(){$bt.list=$j.obj($l.get($bt.LS_TABS))},_broadcast:function(){$bt.send({name:$bt.CMD_SYNC})},_remove:function(n){n||(n=$bt.id);var i=$bt.list.indexOf(n);i>-1&&$bt.list.splice(i,1)},_getHash:function(n){n=window.location.host+"#"+n;for(var i=0,o=0,r=n.length;r>o;o++)i=(i<<5)-i+n.charCodeAt(o),i&=i;return Math.abs(i)},_initConstant:function(n){var i=null!=this.HASH?this.HASH:this._getHash(n);this.LS_TABS=i+".bt.list",this.LS_CURTAB=i+".bt.current",this.LS_CMD=i+".bt.event",this.CMD_SYNC=i+".bt.sync",this.CMD_VAR_SET=i+".bt.varset",this.CMD_VAR_SYNC=i+".bt.varsync",this.CMD_ATTR_SYNC=i+".bt.attr",this.CMD_APPEND=i+".bt.dom.append",this.CMD_PREPEND=i+".bt.dom.prepend",this.CMD_HTML=i+".bt.dom.rewrite",this.CMD_RELOAD=i+".bt.reload",this.CMD_ZOMBKILL=i+".bt.zombkill",this.CMD_DONTKILL=i+".bt.dontkill"},_init:function(n){$(window).on("beforeunload",$bt._unload),$(window).on("storage",$bt._cmd),$bt._defHandlerCurrentTab(),$bt.id=(new Date).getTime();var t=$l.get($bt.LS_TABS);$bt.list=null==t?[]:$j.obj(t),$bt.list.push($bt.id),$l.set($bt.LS_TABS,$j.str($bt.list)),$bt._broadcast(),$bt.log($bt.list),$bt.zkillonload?$bt.zombkill(n):$.isFunc(n)&&n()},_defHandlerCurrentTab:function(){var n="hidden",i="visibilitychange";$.isNone(document.mozHidden)?$.isNone(document.msHidden)?$.isNone(document.webkitHidden)||(n="webkitHidden",i="webkitvisibilitychange"):(n="msHidden",i="msvisibilitychange"):(n="mozHidden",i="mozvisibilitychange"),$(window).on(i,function(){document[n]||($bt.log("SET CURRENT TAB : "+$bt.id),$l.set($bt.LS_CURTAB,$bt.id))},!1)},_dom:function(n,i,s,o,r,b){$bt.send({name:n,context:i,selector:s,data:o,callback:r,to:b?b:"*"})},_unload:function(){return $bt._refresh(),$bt._remove(),$l.set($bt.LS_TABS,$j.str($bt.list)),$bt._broadcast(),null},_cmd:function(i){if($.isNone(i.originalEvent)||(i=i.originalEvent),i.key==$bt.LS_CMD){var n=$j.obj(i.newValue);if(n&&("*"==n.to||n.to==$bt.id)){console.log("RECEIVING cmd "+n.name+" : "),console.log(n);try{n.context=$.isNone(n.context)||null==n.context||$.isNone(window.parent.frames[n.context])?document:window.parent.frames[n.context].document}catch(i){$bt.log("bad context "+n.context+" : "+i.message)}switch($.isFunc($bt.before)&&$bt.before(n),n.name){case $bt.CMD_SYNC:$bt._refresh(),$bt.log($bt.list);break;case $bt.CMD_APPEND:$(n.selector,n.context).append(n.data);break;case $bt.CMD_HTML:$(n.selector,n.context).html(n.data);break;case $bt.CMD_PREPEND:$(n.selector,n.context).prepend(n.data);break;case $bt.CMD_RELOAD:window.location=$.isNone(n.url)?window.location:n.url;break;case $bt.CMD_ZOMBKILL:$bt._dontkill(n.askid,n.from);break;case $bt.CMD_DONTKILL:$bt.zomblist[""+n.askid]["ping"+n.from]="pong";break;case $bt.CMD_VAR_SET:$bt.vars[n.varName]=$j.obj(n.data);break;case $bt.CMD_VAR_SYNC:$.isNone($bt.vars[n.varName])||$bt.varset(n.varName,$bt.vars[n.varName]);break;case $bt.CMD_ATTR_SYNC:n.attr.forEach(function(i,o){"disabled"!=n.attr?$(n.selector,n.context).attr(i,n.data[o]):$(n.selector,n.context).first().disabled=n.data[o]});break;default:$.isFunc($bt.on)&&$bt.on(n)}$.isStr(n.callback)&&n.callback.length>0&&!$.isNone($bt.callbacks[n.callback])&&$.isFunc($bt.callbacks[n.callback])&&($bt.log(n.callback),$bt.callbacks[n.callback].call({},n)),$.isFunc($bt.after)&&$bt.after(n)}}}};
